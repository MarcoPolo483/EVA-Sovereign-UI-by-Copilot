name: Audit PR Comment

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  comment:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Run npm audit
        run: npm audit --json > security-audit.json || true
      - name: Post comment with summary
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('security-audit.json', 'utf8'));
            let crit = 0, high = 0, mod = 0, low = 0;
            if (data.vulnerabilities) {
              crit = data.vulnerabilities.critical || 0;
              high = data.vulnerabilities.high || 0;
              mod = data.vulnerabilities.moderate || 0;
              low = data.vulnerabilities.low || 0;
            }
            const body = `Security audit summary:\n- Critical: ${crit}\n- High: ${high}\n- Moderate: ${mod}\n- Low: ${low}\n\nArtifacts: security-audit.json`;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });