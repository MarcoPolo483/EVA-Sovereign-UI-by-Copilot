name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  CACHE_VERSION: v1

jobs:
  # Job 1: Lint and Type Check
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: TypeScript type check
        run: npm run lint

      - name: Style lint
        run: npm run lint:styles
        continue-on-error: true

  # Job 2: Unit Tests
  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests with coverage
        run: npm run test:coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: Archive coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

  # Job 3: Accessibility Tests
  test-a11y:
    name: Accessibility Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run accessibility tests
        run: npm run test:a11y:automated

      - name: Upload accessibility report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-report
          path: playwright-report/
          retention-days: 30

  # Job 4: Visual Regression Tests
  test-visual:
    name: Visual Regression Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium firefox webkit

      - name: Run visual regression tests
        run: npm run test:visual:ci
        continue-on-error: true

      - name: Upload visual diff report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: visual-regression-report
          path: playwright-report/
          retention-days: 30

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: visual-test-results
          path: test-results/
          retention-days: 30

  # Job 5: Performance Tests
  test-performance:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run performance benchmarks
        run: npm run test:perf
        continue-on-error: true

      - name: Upload performance report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-report
          path: playwright-report/
          retention-days: 30

  # Job 6: Build All Packages
  build:
    name: Build Packages
    runs-on: ubuntu-latest
    needs: [lint, test-unit]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Web Components
        run: npm run build:wc

      - name: Build React wrapper
        run: npm run build:react

      - name: Build Vue wrapper
        run: npm run build:vue

      - name: Build Angular wrapper
        run: npm run build:angular

      - name: Build Svelte wrapper
        run: npm run build:svelte

      - name: Build demo apps
        run: |
          npm run build:devkit
          npm run build:esdc

      - name: Check bundle size
        run: npm run size:guard
        continue-on-error: true

      - name: Archive build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            packages/eva-sovereign-ui-wc/dist/
            packages/eva-sovereign-ui-react/dist/
            packages/eva-sovereign-ui-vue/dist/
            packages/eva-sovereign-ui-angular/dist/
            packages/eva-sovereign-ui-svelte/dist/
            dist-devkit/
            dist-esdc/
          retention-days: 30

  # Job 7: Security Audit
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --json > security-audit.json
        continue-on-error: true

      - name: Generate SBOM
        run: npm run sbom
        continue-on-error: true

      - name: Check licenses
        run: npm run licenses:audit
        continue-on-error: true

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            security-audit.json
            sbom.json
            licenses.json
          retention-days: 90

  # Job 8: Deploy Storybook (main branch only)
  deploy-storybook:
    name: Deploy Storybook
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Storybook
        run: npm run build-storybook

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./storybook-static
          cname: storybook.eva-sovereign-ui.dev
        continue-on-error: true

  # Job 9: Deploy Demo Apps (main branch only)
  deploy-demos:
    name: Deploy Demo Apps
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - name: Deploy Dev Kit to Netlify
        uses: nwtgck/actions-netlify@v2.1
        with:
          publish-dir: './dist-devkit'
          production-branch: main
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Deploy from GitHub Actions"
          enable-pull-request-comment: true
          enable-commit-comment: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_DEVKIT_SITE_ID }}
        timeout-minutes: 5
        continue-on-error: true

      - name: Deploy ESDC Demo to Netlify
        uses: nwtgck/actions-netlify@v2.1
        with:
          publish-dir: './dist-esdc'
          production-branch: main
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Deploy from GitHub Actions"
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_ESDC_SITE_ID }}
        timeout-minutes: 5
        continue-on-error: true

  # Job 10: Notify on Completion
  notify:
    name: Notification
    runs-on: ubuntu-latest
    needs: [lint, test-unit, test-a11y, test-visual, test-performance, build, security]
    if: always()
    steps:
      - name: Check job status
        run: |
          echo "Lint: ${{ needs.lint.result }}"
          echo "Unit Tests: ${{ needs.test-unit.result }}"
          echo "Accessibility: ${{ needs.test-a11y.result }}"
          echo "Visual: ${{ needs.test-visual.result }}"
          echo "Performance: ${{ needs.test-performance.result }}"
          echo "Build: ${{ needs.build.result }}"
          echo "Security: ${{ needs.security.result }}"

      - name: Send notification
        run: |
          if [ "${{ needs.lint.result }}" == "success" ] && [ "${{ needs.test-unit.result }}" == "success" ] && [ "${{ needs.build.result }}" == "success" ]; then
            echo "✅ Pipeline succeeded!"
          else
            echo "❌ Pipeline failed!"
            exit 1
          fi
